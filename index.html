<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²è·¯æˆ°ç¥æŒ‘æˆ°è³½</title>
    <style>
        :root {
            --primary: #00eaff;
            --danger: #ff3333;
            --warning: #ffeb3b;
            --bg-dark: #1a1a1a;
            --panel-bg: rgba(30, 30, 30, 0.9);
            --glow-color: rgba(255, 255, 255, 0.2);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #222;
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            color: white;
            user-select: none;
        }

        /* éŠæˆ²ä¸»ç•«é¢ */
        #game-area {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom, #111, #000);
            cursor: default;
        }

        /* ä»‹é¢é¢æ¿ï¼ˆé è¨­ï¼šå·¦å´ï¼‰ */
        #ui-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 20;
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(8px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            width: 260px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            transition: border-color 0.3s, box-shadow 0.3s, transform 0.1s,
                        top 0.2s, left 0.2s, width 0.2s, border-radius 0.2s,
                        background 0.2s;
        }

        /* æœ€é«˜æ®µä½æ‰æŠ–å‹•ç™¼å…‰ */
        .ui-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) infinite;
            box-shadow: 0 0 20px var(--glow-color) !important;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 1.05rem;
            align-items: center;
        }

        .highlight { color: var(--primary); font-weight: bold; }
        .combo-text { color: var(--warning); font-weight: bold; }
        .level-text { color: #ff00aa; font-weight: bold; }

        /* ç”Ÿå‘½å€¼ (æ„›å¿ƒ) */
        #lives-container {
            color: var(--danger);
            font-size: 1.2rem;
            letter-spacing: 2px;
            text-shadow: 0 0 5px var(--danger);
        }
        
        /* æ®µä½é¡¯ç¤º */
        #rank-container {
            margin-top: 5px;
            padding: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            text-align: center;
        }
        #rank-icon { font-size: 1.5rem; margin-right: 5px; }
        #rank-name { font-weight: bold; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.5); }

        .divider {
            height: 1px;
            background: rgba(255,255,255,0.2);
            margin: 10px 0;
        }

        /* è¨­å®šå€æŠ˜ç–Š */
        #toggle-settings-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #ddd;
            cursor: pointer;
            width: 100%;
            text-align: left;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        
        #toggle-settings-btn:hover { background: rgba(255,255,255,0.2); }
        #toggle-settings-btn::after {
            content: 'â–¼';
            font-size: 0.7rem;
            margin-left: auto;
            transition: transform 0.3s;
        }
        .settings-collapsed #toggle-settings-btn::after { transform: rotate(-90deg); }

        #settings-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-top 0.3s;
            max-height: 800px;
            opacity: 1;
            margin-top: 10px;
        }
        .settings-collapsed #settings-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        /* æ§åˆ¶é …æ¨£å¼ */
        label {
            display: block;
            font-size: 0.85rem;
            margin-top: 8px;
            color: #ccc;
        }
        select, input[type=range] { width: 100%; margin-bottom: 5px; }

        input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #222;
            color: #fff;
            box-sizing: border-box;
            margin-bottom: 4px;
        }
        
        .checkbox-row {
            display: flex;
            align-items: center;
            margin-top: 8px;
            cursor: pointer;
        }
        .checkbox-row input { margin-right: 8px; width: auto; }

        /* åº•éƒ¨æŒ‰éˆ• */
        #main-btn {
            background-color: var(--primary);
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: #000;
            margin-top: 15px;
            width: 100%;
            font-size: 1.1rem;
            text-transform: uppercase;
            transition: transform 0.1s, background 0.2s;
        }
        #main-btn:active { transform: scale(0.98); }
        #main-btn:hover { background-color: #00ddee; }
        
        /* çµ‚æ­¢æŒ‰éˆ•æ¨£å¼ (æŒ‘æˆ°æ¨¡å¼ç”¨) */
        .btn-terminate {
            background-color: var(--danger) !important;
            color: white !important;
        }

        /* éŠæˆ²ç‰©ä»¶ */
        .letter {
            position: absolute;
            font-size: 2.5rem;
            font-weight: bold;
            color: #00ff00;
            text-shadow: 0 0 10px currentColor;
            top: -60px;
            white-space: nowrap;
            z-index: 5;
            will-change: transform, top; 
        }

        /* æµ®å‹•æ–‡å­—ç‰¹æ•ˆ */
        .float-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            z-index: 15;
            text-shadow: 2px 2px 0 #000;
        }
        
        /* æ™‰å‡æ®µä½ç‰¹æ•ˆæ–‡å­— */
        .rank-up-text {
            font-size: 2.5rem !important;
            color: #fff !important;
            text-shadow: 0 0 15px gold, 2px 2px 0 #000 !important;
            z-index: 100;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }

        /* æ“Šä¸­çˆ†ç‚¸ */
        .poof { animation: poof-anim 0.2s ease-out forwards; }
        @keyframes poof-anim {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* å…¨è¢å¹•è¦†è“‹å±¤ */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
            display: none;
        }

        /* Game Over å…§å®¹ */
        .game-over-box {
            text-align: center;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: rgba(40,40,40,0.9);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid #555;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .game-over-title {
            font-size: 3rem;
            color: var(--danger);
            margin-bottom: 10px;
            text-shadow: 0 0 20px red;
        }
        .stat-result { font-size: 1.1rem; margin: 6px 0; color: #eee; }
        
        .btn-group { display: flex; gap: 15px; justify-content: center; margin-top: 25px; }
        
        .restart-btn, .share-btn {
            padding: 12px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .restart-btn { background: var(--primary); color: black; }
        .share-btn { background: #25d366; color: white; }
        
        .restart-btn:active, .share-btn:active { transform: scale(0.95); }

        /* å€’æ•¸è¨ˆæ™‚å€å¡Šï¼ˆåªçµ¦æŒ‘æˆ°æ¨¡å¼ç”¨ï¼‰ */
        #countdown-display {
            font-size: 8rem;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 0 30px var(--primary);
        }
        #abort-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: transparent;
            border: 2px solid #666;
            color: #aaa;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
        }
        #abort-btn:hover { border-color: #fff; color: #fff; }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* åº•éƒ¨æç¤º */
        #footer-hint {
            position: absolute;
            bottom: 10px;
            left: 15px;
            color: #666;
            font-size: 0.8rem;
            pointer-events: none;
        }
        
        .hint-box {
            background: #333;
            color: #aaa;
            padding: 8px;
            font-size: 0.8rem;
            border-radius: 4px;
            margin-top: 5px;
            line-height: 1.4;
        }
        .hint-box.small {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        /* =========================
           éŠæˆ²ä¸­ï¼šUI è®Šæˆä¸Šæ–¹æ©«æ¢
           ========================= */
        body.playing #ui-panel {
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-width: none;
            border-radius: 0;
            border-left: none;
            border-right: none;
            background: rgba(10,10,10,0.5);
            
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px;
        }

        body.playing #ui-panel:hover {
            background: rgba(10,10,10,0.85);
        }

        body.playing #ui-panel .stat-row {
            margin: 0;
            font-size: 0.85rem;
            width: auto;
        }

        body.playing #challenge-stats {
            display: flex !important;
            align-items: center;
            gap: 10px;
        }

        body.playing #rank-container {
            margin-top: 0;
            padding: 4px 10px;
            border-radius: 999px;
        }

        body.playing #settings-content {
            display: none;
        }

        body.playing #main-btn {
            margin-left: auto;
            width: auto;
            padding: 6px 12px;
            font-size: 0.8rem;
            margin-top: 0;
        }

        body.playing .divider {
            display: none;
        }
    </style>
</head>
<body>

    <div id="game-area">
        <!-- ä»‹é¢ -->
        <div id="ui-panel">
            <div class="stat-row">
                <span>åˆ†æ•¸</span>
                <span id="score" class="highlight">0</span>
            </div>
            
            <!-- æŒ‘æˆ°æ¨¡å¼å°ˆç”¨é¡¯ç¤º -->
            <div id="challenge-stats" style="display:none;">
                <div class="divider"></div>
                <div id="rank-container">
                    <span id="rank-icon">ğŸ¥‰</span>
                    <span id="rank-name">LV.1 éµç›¤è·¯äººç”²</span>
                </div>
                <div class="divider"></div>
                
                <div class="stat-row">
                    <span>é—œå¡ Lv.</span>
                    <span id="level-display" class="level-text">1</span>
                </div>
                <div class="stat-row">
                    <span>ç”Ÿå‘½</span>
                    <span id="lives-container">â¤â¤â¤</span>
                </div>
            </div>

            <div class="divider"></div>

            <div class="stat-row">
                <span>é€£æ“Š</span>
                <span id="combo" class="combo-text">0</span>
            </div>
            <div class="stat-row" style="font-size: 0.8rem; color: #aaa;">
                <span>æœ€é«˜é€£æ“Š</span>
                <span id="max-combo">0</span>
            </div>

            <div class="divider"></div>

            <!-- æŠ˜ç–Šè¨­å®š -->
            <button id="toggle-settings-btn">âš™ï¸ è¨­å®šé¸é …</button>
            <div id="settings-content">
                <label>ç©å®¶åç¨±</label>
                <input type="text" id="player-name" placeholder="è¼¸å…¥ä½ çš„ID" maxlength="12">
                <div class="hint-box small">æœªå¡«å¯«æœƒä»¥ã€Œç„¡åæˆ°ç¥ã€è¨˜éŒ„ã€‚</div>
                
                <label>éŠç©æ¨¡å¼</label>
                <select id="game-mode-select">
                    <option value="noob">ğŸ¥¬ èœé³¥æ¨¡å¼ (ä¸æ­»èº«)</option>
                    <option value="challenge">ğŸ”¥ æŒ‘æˆ°æ¨¡å¼ (æ’ä½è³½)</option>
                </select>
                <div id="mode-desc" class="hint-box">ä¸æœƒçµæŸï¼Œæ¼æ¥æ‰£å…‰åˆ†ã€‚</div>

                <label>è¼¸å…¥æ³•</label>
                <select id="input-mode-select">
                    <option value="english">è‹±æ–‡ + æ•¸å­—</option>
                    <option value="bopomofo">æ³¨éŸ³ (æ¨™æº–éµç›¤)</option>
                </select>
                <div class="hint-box" style="color: #ffaa00;">*è«‹å‹™å¿…é—œé–‰ä¸­æ–‡è¼¸å…¥æ³•</div>

                <label class="checkbox-row">
                    <input type="checkbox" id="sound-toggle" checked> ğŸ”Š é–‹å•ŸéŸ³æ•ˆ
                </label>

                <!-- åªæœ‰èœé³¥æ¨¡å¼é¡¯ç¤ºæ‰‹å‹•é›£åº¦ -->
                <div id="manual-difficulty">
                    <label>æ‰è½é€Ÿåº¦ (1-10)</label>
                    <input type="range" id="speed-range" min="1" max="10" value="3">
                    
                    <label>ç”Ÿæˆé »ç‡ (1-10)</label>
                    <input type="range" id="rate-range" min="1" max="10" value="3">
                </div>
            </div>

            <button id="main-btn">é–‹å§‹éŠæˆ²</button>
        </div>

        <div id="footer-hint">ğŸ’¡ å»ºè­°ä½¿ç”¨é›»è…¦éµç›¤éŠç©</div>
    </div>

    <!-- å€’æ•¸è¨ˆæ™‚å±¤ï¼ˆåªçµ¦æŒ‘æˆ°æ¨¡å¼ç”¨ï¼‰ -->
    <div id="countdown-overlay" class="overlay">
        <div id="countdown-display">3</div>
        <button id="abort-btn" onclick="abortCountdown()">âœ– å–æ¶ˆ</button>
    </div>

    <!-- Game Over å±¤ -->
    <div id="gameover-overlay" class="overlay">
        <div class="game-over-box">
            <!-- ğŸ”¥ æŠŠ GAME OVER æ”¹æˆæ®µä½é¡¯ç¤ºï¼Œä¸¦çµ¦ id="go-title" -->
            <div class="game-over-title" id="go-title">æ®µä½ï¼šLV.1 éµç›¤è·¯äººç”²</div>
            <div class="stat-result">ç©å®¶ï¼š<span id="go-player" style="color:var(--primary)">ç„¡åæˆ°ç¥</span></div>
            <div class="stat-result">æ™‚é–“ï¼š<span id="go-date" style="color:#ddd">-</span></div>
            <div class="stat-result">æ¨¡å¼ï¼š<span id="go-mode" style="color:#ccc">-</span></div>
            <div class="stat-result">æœ¬æ¬¡åˆ†æ•¸ï¼š<span id="go-score" style="color:var(--primary)">0</span></div>
            <!-- â›” é€™è£¡åŸæœ¬çš„ã€Œæ®µä½ï¼š<span id=go-rank>ã€æ•´è¡Œå·²åˆªé™¤ -->
            <div class="stat-result">æœ€é«˜é€£æ“Šï¼š<span id="go-combo" style="color:var(--warning)">0</span></div>
            
            <div class="btn-group">
                <button class="share-btn" onclick="copyResult()">ğŸ“‹ è¤‡è£½æˆç¸¾</button>
                <button class="restart-btn" onclick="prepareGame()">å†ç©ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <script>
        /* --- 1. å¸¸æ•¸èˆ‡è¨­å®š --- */
        const CONSTANTS = {
            POINTS_PER_HIT: 10,
            MAX_LIVES: 3,
            RANK_BASE_HITS: 10,
            RANK_HITS_INCREMENT: 10,
            // å°‡ã€Œé€Ÿåº¦ç­‰ç´š / ç”Ÿæˆç­‰ç´šã€è½‰æˆå¯¦éš›é€Ÿåº¦èˆ‡ç”Ÿæˆ frame é–“éš”çš„ä¿‚æ•¸
            SPEED_LEVEL_BASE: 0.8,   // é€Ÿåº¦ç­‰ç´š1
            SPEED_LEVEL_STEP: 0.35,  // æ¯å‡ä¸€ç´šé€Ÿåº¦åŠ å¤šå°‘
            RATE_LEVEL_BASE: 110,    // ç”Ÿæˆç­‰ç´š1
            RATE_LEVEL_STEP: 10,     // æ¯å‡ä¸€ç´šç”Ÿæˆé€Ÿåº¦å¿«å¤šå°‘ï¼ˆé–“éš”è®Šå°ï¼‰
            STORAGE_KEY: 'net_war_god_records_v1'
        };

        // 19 æ®µä½åç¨±ï¼ˆLV.1ï½LV.19ï¼‰
        const RANKS = [
            { title: "éµç›¤è·¯äººç”²",   icon: "âšª", color: "#aaaaaa" },
            { title: "æ–°æ‰‹å™´å­",     icon: "ğŸ¼", color: "#b0c4de" },
            { title: "ç•™è¨€è¦‹ç¿’ç”Ÿ",   icon: "ğŸ“", color: "#88c0d0" },
            { title: "é…¸æ°‘å¯¦ç¿’ä¸­",   icon: "ğŸ¥š", color: "#8fbc8f" },
            { title: "å˜´ç ²ç·´ç¿’ç”Ÿ",   icon: "ğŸ¯", color: "#ffd27f" },
            { title: "å›å˜´å°èƒ½æ‰‹",   icon: "ğŸ’¬", color: "#ffb74d" },
            { title: "éµç›¤é¬¥å£«",     icon: "âš”ï¸", color: "#ff9800" },
            { title: "å˜´ç ²å°éšŠé•·",   icon: "ğŸ›¡ï¸", color: "#ff9100" },
            { title: "æˆ°å¸–å°ˆå“¡",     icon: "ğŸ“œ", color: "#ff7043" },
            { title: "ç¶²è·¯æˆ°å£«",     icon: "ğŸ”¥", color: "#ff5722" },
            { title: "ç•™è¨€å€éœ¸ä¸»",   icon: "ğŸŸï¸", color: "#ff4081" },
            { title: "éµç›¤æ•™å®˜",     icon: "ğŸ“¢", color: "#e040fb" },
            { title: "é…¸æ°‘çµ±å¸¥",     icon: "ğŸ‘‘", color: "#d500f9" },
            { title: "æˆ°å¸–æŒ‡æ®å®˜",   icon: "ğŸ–ï¸", color: "#ab47bc" },
            { title: "å˜´ç ²æˆ°ç¥",     icon: "ğŸ’¥", color: "#9c27b0" },
            { title: "å‚³èªªç´šé…¸æ°‘",   icon: "ğŸŒªï¸", color: "#7b1fa2" },
            { title: "ç¦è¨€ç ´å£è€…",   icon: "ğŸš«", color: "#f44336" },
            { title: "ç¶²è·¯ä¿®ç¾…",     icon: "ğŸ’€", color: "#e53935" },
            { title: "éµç›¤ä¿ ",       icon: "ğŸ˜ˆ", color: "#ff0000" }
        ];

        // ç­‰ç´š 1ï½19 â†’ å°æ‡‰ã€Œé€Ÿåº¦ç­‰ç´š / ç”Ÿæˆç­‰ç´šã€
        const LEVEL_CONFIG = [
            { speedLevel: 1, rateLevel: 1 },  // Lv1
            { speedLevel: 2, rateLevel: 1 },  // Lv2
            { speedLevel: 2, rateLevel: 2 },  // Lv3
            { speedLevel: 3, rateLevel: 2 },  // Lv4
            { speedLevel: 3, rateLevel: 3 },  // Lv5
            { speedLevel: 4, rateLevel: 3 },  // Lv6
            { speedLevel: 4, rateLevel: 4 },  // Lv7
            { speedLevel: 5, rateLevel: 4 },  // Lv8
            { speedLevel: 5, rateLevel: 5 },  // Lv9
            { speedLevel: 6, rateLevel: 5 },  // Lv10
            { speedLevel: 6, rateLevel: 6 },  // Lv11
            { speedLevel: 7, rateLevel: 6 },  // Lv12
            { speedLevel: 7, rateLevel: 7 },  // Lv13
            { speedLevel: 8, rateLevel: 7 },  // Lv14
            { speedLevel: 8, rateLevel: 8 },  // Lv15
            { speedLevel: 9, rateLevel: 8 },  // Lv16
            { speedLevel: 9, rateLevel: 9 },  // Lv17
            { speedLevel:10, rateLevel: 9 },  // Lv18
            { speedLevel:10, rateLevel:10 }   // Lv19
        ];
        const MAX_RANK_INDEX = LEVEL_CONFIG.length - 1;

        const BOPOMOFO_MAP = [
            {char:'ã„…', key:'1'}, {char:'ã„†', key:'q'}, {char:'ã„‡', key:'a'}, {char:'ã„ˆ', key:'z'},
            {char:'ã„‰', key:'2'}, {char:'ã„Š', key:'w'}, {char:'ã„‹', key:'s'}, {char:'ã„Œ', key:'x'},
            {char:'ã„', key:'e'}, {char:'ã„', key:'d'}, {char:'ã„', key:'c'},
            {char:'ã„', key:'r'}, {char:'ã„‘', key:'f'}, {char:'ã„’', key:'v'},
            {char:'ã„“', key:'5'}, {char:'ã„”', key:'t'}, {char:'ã„•', key:'g'}, {char:'ã„–', key:'b'},
            {char:'ã„—', key:'y'}, {char:'ã„˜', key:'h'}, {char:'ã„™', key:'n'},
            {char:'ã„§', key:'u'}, {char:'ã„¨', key:'j'}, {char:'ã„©', key:'m'},
            {char:'ã„š', key:'8'}, {char:'ã„›', key:'i'}, {char:'ã„œ', key:'k'}, {char:'ã„', key:','},
            {char:'ã„', key:'9'}, {char:'ã„Ÿ', key:'o'}, {char:'ã„ ', key:'l'}, {char:'ã„¡', key:'.'},
            {char:'ã„¢', key:'0'}, {char:'ã„£', key:'p'}, {char:'ã„¤', key:';'}, {char:'ã„¥', key:'/'},
            {char:'ã„¦', key:'-'}, {char:'Ë‡', key:'3'}, {char:'Ë‹', key:'4'}, {char:'ËŠ', key:'6'}, {char:'Ë™', key:'7'}
        ];

        /* --- 2. éŸ³æ•ˆç³»çµ± --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const Sound = {
            playTone: (freq, type, duration, vol=0.1) => {
                const soundToggle = document.getElementById('sound-toggle');
                if (!soundToggle || !soundToggle.checked) return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            hit: () => Sound.playTone(880, 'sine', 0.1, 0.1),
            hitHigh: () => { 
                Sound.playTone(880, 'sine', 0.1, 0.1); 
                setTimeout(() => Sound.playTone(1100, 'sine', 0.15, 0.1), 50); 
            },
            miss: () => Sound.playTone(150, 'sawtooth', 0.3, 0.15),
            levelUp: () => {
                Sound.playTone(440, 'square', 0.1);
                setTimeout(() => Sound.playTone(554, 'square', 0.1), 100);
                setTimeout(() => Sound.playTone(659, 'square', 0.2), 200);
            }
        };

        /* --- 3. éŠæˆ²è®Šæ•¸ --- */
        const state = {
            isPlaying: false,
            isPaused: false,
            gameMode: 'noob',
            inputMode: 'english',
            score: 0,
            combo: 0,
            maxCombo: 0,
            highScore: 0,

            lives: CONSTANTS.MAX_LIVES,

            currentRankIndex: 0,       // 0ï½18 å°æ‡‰ LV.1ï½LV.19
            rankHitsRequired: CONSTANTS.RANK_BASE_HITS,
            rankHitsProgress: 0,

            speedLevel: 1,
            rateLevel: 1,
            speed: 1,
            rate: 100,

            spawnTimer: 0,
            letters: [],
            countdownTimer: null,
            lastRecord: null
        };

        // DOM
        const els = {
            gameArea: document.getElementById('game-area'),
            uiPanel: document.getElementById('ui-panel'),
            score: document.getElementById('score'),
            combo: document.getElementById('combo'),
            maxCombo: document.getElementById('max-combo'),
            mainBtn: document.getElementById('main-btn'),
            settingsBtn: document.getElementById('toggle-settings-btn'),
            settingsContent: document.getElementById('settings-content'),
            modeSelect: document.getElementById('game-mode-select'),
            inputSelect: document.getElementById('input-mode-select'),
            modeDesc: document.getElementById('mode-desc'),
            manualDiff: document.getElementById('manual-difficulty'),
            challengeStats: document.getElementById('challenge-stats'),
            levelDisplay: document.getElementById('level-display'),
            livesContainer: document.getElementById('lives-container'),
            rankIcon: document.getElementById('rank-icon'),
            rankName: document.getElementById('rank-name'),
            countOverlay: document.getElementById('countdown-overlay'),
            countDisplay: document.getElementById('countdown-display'),
            goOverlay: document.getElementById('gameover-overlay'),
            goTitle: document.getElementById('go-title'),   // ğŸ”¥ æ–°çš„æ¨™é¡Œå…ƒç´ 
            goScore: document.getElementById('go-score'),
            goCombo: document.getElementById('go-combo'),
            speedRange: document.getElementById('speed-range'),
            rateRange: document.getElementById('rate-range'),
            playerName: document.getElementById('player-name'),
            goPlayer: document.getElementById('go-player'),
            goDate: document.getElementById('go-date'),
            goMode: document.getElementById('go-mode')
        };

        /* --- 4. å·¥å…·å‡½å¼ï¼šæ¨¡å¼ä¸­æ–‡åç¨± --- */
        function getGameModeLabel(mode) {
            return mode === 'challenge' ? 'æŒ‘æˆ°æ¨¡å¼' : 'èœé³¥æ¨¡å¼';
        }
        function getInputModeLabel(mode) {
            return mode === 'bopomofo' ? 'æ³¨éŸ³' : 'è‹±æ–‡ï¼‹æ•¸å­—';
        }

        /* --- 5. è¨˜éŒ„å„²å­˜ --- */
        function saveRecord(record) {
            let arr;
            try {
                arr = JSON.parse(localStorage.getItem(CONSTANTS.STORAGE_KEY) || '[]');
            } catch {
                arr = [];
            }
            arr.unshift(record);
            if (arr.length > 20) arr = arr.slice(0, 20);
            localStorage.setItem(CONSTANTS.STORAGE_KEY, JSON.stringify(arr));
        }

        /* --- 6. å°‡æ®µä½ç­‰ç´š â†’ å¯¦éš›é€Ÿåº¦èˆ‡ç”Ÿæˆé »ç‡ --- */
        function applyLevelConfig() {
            const idx = Math.min(state.currentRankIndex, MAX_RANK_INDEX);
            const cfg = LEVEL_CONFIG[idx];
            state.speedLevel = cfg.speedLevel;
            state.rateLevel = cfg.rateLevel;

            state.speed = CONSTANTS.SPEED_LEVEL_BASE +
                          CONSTANTS.SPEED_LEVEL_STEP * (state.speedLevel - 1);
            state.rate = CONSTANTS.RATE_LEVEL_BASE - 
                         CONSTANTS.RATE_LEVEL_STEP * (state.rateLevel - 1);

            if (state.rate < 10) state.rate = 10;
        }

        /* --- 7. æ ¸å¿ƒé‚è¼¯åˆå§‹åŒ– --- */
        function init() {
            document.body.classList.remove('playing');
            els.uiPanel.classList.add('settings-collapsed');

            updateUIState();
            els.settingsBtn.addEventListener('click', () => els.uiPanel.classList.toggle('settings-collapsed'));
            
            els.mainBtn.addEventListener('click', () => {
                if (!state.isPlaying) {
                    prepareGame();
                } else {
                    handleMainButtonAction();
                }
            });
            
            els.modeSelect.addEventListener('change', () => {
                state.gameMode = els.modeSelect.value;
                updateUIState();
            });
            
            els.inputSelect.addEventListener('change', () => state.inputMode = els.inputSelect.value);

            const updateManual = () => {
                if (state.gameMode === 'noob') {
                    state.speed = parseInt(els.speedRange.value) * 0.8;
                    state.rate = 110 - (parseInt(els.rateRange.value) * 10);
                }
            };
            els.speedRange.addEventListener('input', updateManual);
            els.rateRange.addEventListener('input', updateManual);

            requestAnimationFrame(gameLoop);
        }

        function updateUIState() {
            const isChallenge = state.gameMode === 'challenge';
            els.manualDiff.style.display = isChallenge ? 'none' : 'block';
            els.challengeStats.style.display = isChallenge ? 'block' : 'none';
            
            if (isChallenge) {
                els.modeDesc.innerHTML = "ç„¡æ³•æš«åœï¼Œæœ‰ç”Ÿå‘½å€¼ï¼Œ<br>é æ“Šä¸­æ¬¡æ•¸å‡æ®µã€‚";
                els.mainBtn.classList.add('btn-terminate');
                els.mainBtn.style.backgroundColor = "var(--danger)";
            } else {
                els.modeDesc.innerHTML = "ä¸æ­»ä¹‹èº«ï¼Œæ¼æ¥æ‰£å…‰åˆ†ã€‚<br>å¯æš«åœèˆ‡è‡ªè¨‚é€Ÿåº¦ã€‚";
                els.mainBtn.classList.remove('btn-terminate');
                els.mainBtn.style.backgroundColor = "var(--primary)";
            }
        }

        function handleMainButtonAction() {
            if (state.gameMode === 'challenge') {
                if (confirm("ç¢ºå®šè¦æ”¾æ£„æŒ‘æˆ°å—ï¼Ÿ")) {
                    gameOver();
                }
            } else {
                togglePause();
            }
        }

        function prepareGame() {
            els.goOverlay.style.display = 'none';
            state.score = 0;
            state.combo = 0;
            state.maxCombo = 0;
            state.letters.forEach(l => l.element.remove());
            state.letters = [];
            
            els.score.innerText = 0;
            els.combo.innerText = 0;
            els.maxCombo.innerText = 0;
            updateVisualEffects();

            if (state.gameMode === 'challenge') {
                state.lives = CONSTANTS.MAX_LIVES;
                state.currentRankIndex = 0;
                state.rankHitsRequired = CONSTANTS.RANK_BASE_HITS;
                state.rankHitsProgress = 0;

                applyLevelConfig();
                updateChallengeUI();
                updateRank();

                els.uiPanel.classList.add('settings-collapsed');
                startCountdown();
            } else {
                // èœé³¥æ¨¡å¼ï¼šä½¿ç”¨æ‰‹å‹•è¨­å®šé€Ÿåº¦
                state.speed = parseInt(els.speedRange.value) * 0.8;
                state.rate = 110 - (parseInt(els.rateRange.value) * 10);
                els.uiPanel.classList.add('settings-collapsed');
                startGame(); // ç„¡å€’æ•¸ï¼Œç›´æ¥é–‹å§‹
            }
        }

        function startCountdown() {
            els.countOverlay.style.display = 'flex';
            let count = 3;
            els.countDisplay.innerText = count;
            
            if (state.countdownTimer) clearInterval(state.countdownTimer);

            state.countdownTimer = setInterval(() => {
                count--;
                if (count > 0) {
                    els.countDisplay.innerText = count;
                } else if (count === 0) {
                    els.countDisplay.innerText = "GO!";
                } else {
                    clearInterval(state.countdownTimer);
                    els.countOverlay.style.display = 'none';
                    startGame();
                }
            }, 800);
        }
        
        // å€’æ•¸ä¸­æ–·ï¼ˆæŒ‘æˆ°æ¨¡å¼ç”¨ï¼‰
        window.abortCountdown = function() {
            if (state.countdownTimer) clearInterval(state.countdownTimer);
            els.countOverlay.style.display = 'none';
        };

        function startGame() {
            state.isPlaying = true;
            state.isPaused = false;

            document.body.classList.add('playing');
            
            if (state.gameMode === 'challenge') {
                els.mainBtn.innerText = "ğŸ›‘ çµ‚æ­¢éŠæˆ²";
                els.mainBtn.classList.add('btn-terminate');
                els.mainBtn.style.backgroundColor = "var(--danger)";
            } else {
                els.mainBtn.innerText = "æš«åœ (ESC)";
                els.mainBtn.classList.remove('btn-terminate');
                els.mainBtn.style.backgroundColor = "#ffaa00";
            }

            updateVisualEffects();
        }

        function togglePause() {
            state.isPaused = !state.isPaused;

            if (state.isPaused) {
                // æš«åœï¼šå›åˆ°å·¦å´å¤§é¢æ¿ã€å¯ç”¨è¨­å®šæŠ˜ç–Š
                document.body.classList.remove('playing');
                els.mainBtn.innerText = "ç¹¼çºŒ";
                els.mainBtn.style.backgroundColor = "var(--primary)";
            } else {
                // ç¹¼çºŒï¼šå›åˆ°ä¸Šæ–¹æ©«æ¢ HUD
                document.body.classList.add('playing');
                els.mainBtn.innerText = "æš«åœ (ESC)";
                els.mainBtn.style.backgroundColor = "#ffaa00";
            }

            updateVisualEffects();
        }

        function gameOver() {
            state.isPlaying = false;
            state.isPaused = false;
            Sound.miss();

            document.body.classList.remove('playing');
            updateVisualEffects();

            els.goScore.innerText = state.score;
            els.goCombo.innerText = state.maxCombo;
            
            const finalRank = RANKS[state.currentRankIndex] || RANKS[0];
            const level = state.currentRankIndex + 1;
            // ğŸ”¥ æŠŠæ®µä½é¡¯ç¤ºåˆ°ä¸Šæ–¹å¤§æ¨™é¡Œ
            els.goTitle.innerText = `æ®µä½ï¼šLV.${level} ${finalRank.title}`;
            els.goTitle.style.color = finalRank.color;

            // ç©å®¶åç¨± / æ—¥æœŸ / æ¨¡å¼è³‡è¨Š
            const rawName = (els.playerName.value || '').trim();
            const playerName = rawName || 'ç„¡åæˆ°ç¥';
            const now = new Date();
            const dateStr = now.toLocaleString('zh-TW', { hour12: false });
            const gameModeLabel = getGameModeLabel(state.gameMode);
            const inputModeLabel = getInputModeLabel(state.inputMode);

            els.goPlayer.innerText = playerName;
            els.goDate.innerText = dateStr;
            els.goMode.innerText = `${gameModeLabel} ï¼ ${inputModeLabel}`;

            // å­˜æˆä¸€ç­†ç´€éŒ„
            const record = {
                player: playerName,
                date: dateStr,
                score: state.score,
                maxCombo: state.maxCombo,
                rankTitle: finalRank.title,
                rankIcon: finalRank.icon,
                gameMode: state.gameMode,
                gameModeLabel,
                inputMode: state.inputMode,
                inputModeLabel,
                level: level
            };
            state.lastRecord = record;
            saveRecord(record);
            
            els.goOverlay.style.display = 'flex';
            els.mainBtn.innerText = "é–‹å§‹éŠæˆ²";
            els.mainBtn.classList.remove('btn-terminate');
            els.mainBtn.style.backgroundColor = "var(--primary)";
        }

        function updateChallengeUI() {
            const level = state.currentRankIndex + 1;
            els.levelDisplay.innerText = level;
            let hearts = "";
            for (let i = 0; i < state.lives; i++) hearts += "â¤";
            els.livesContainer.innerText = hearts || "Ã—";
        }

        // æ®µä½ï¼šç”¨ã€Œæ“Šä¸­æ¬¡æ•¸ã€ä¾†å‡ç´šï¼ˆ10, 20, 30...ï¼‰
        function checkRankByHits() {
            if (state.gameMode !== 'challenge') return;
            if (state.currentRankIndex >= MAX_RANK_INDEX) return;

            state.rankHitsProgress += 1;

            if (state.rankHitsProgress >= state.rankHitsRequired) {
                state.rankHitsProgress = 0;
                state.rankHitsRequired += CONSTANTS.RANK_HITS_INCREMENT;

                state.currentRankIndex++;
                applyLevelConfig();
                updateChallengeUI();
                updateRank(true);
            }
        }

        function updateRank(showEffect = false) {
            const r = RANKS[state.currentRankIndex] || RANKS[0];
            const level = state.currentRankIndex + 1;

            els.rankIcon.innerText = r.icon;
            els.rankName.innerText = `LV.${level} ${r.title}`;
            els.rankName.style.color = r.color;
            
            els.uiPanel.style.borderColor = r.color;
            document.documentElement.style.setProperty('--glow-color', r.color);

            if (showEffect) {
                Sound.levelUp();
                showFloatingText(
                    window.innerWidth / 2 - 120,
                    window.innerHeight / 2,
                    `æ™‰å‡ï¼LV.${level} ${r.title}`,
                    false,
                    true
                );
            }

            // æ®µä½è®ŠåŒ–æ™‚æ›´æ–°ç‰¹æ•ˆï¼ˆæœ€é«˜æ®µæ‰æœƒæŠ–ï¼‰
            updateVisualEffects();
        }

        // è¦–è¦ºç‰¹æ•ˆæ§åˆ¶ï¼šåªæœ‰æœ€é«˜æ®µä½ & éŠæˆ²ä¸­ & æœªæš«åœ æ‰æŠ–å‹•
        function updateVisualEffects() {
            const isMaxRank = state.currentRankIndex >= MAX_RANK_INDEX;
            if (isMaxRank && state.isPlaying && !state.isPaused) {
                els.uiPanel.classList.add('ui-shake');
            } else {
                els.uiPanel.classList.remove('ui-shake');
            }
        }

        // è¤‡è£½æˆç¸¾åŠŸèƒ½
        window.copyResult = function() {
            const finalRank = RANKS[state.currentRankIndex] || RANKS[0];
            const level = state.currentRankIndex + 1;
            const rec = state.lastRecord;
            const baseInfo = rec
                ? `ç©å®¶ï¼š${rec.player}\næ™‚é–“ï¼š${rec.date}\næ¨¡å¼ï¼š${rec.gameModeLabel}ï¼${rec.inputModeLabel}\n`
                : '';
            const text =
`${baseInfo}æˆ‘åœ¨ã€Šç¶²è·¯æˆ°ç¥æ’ä½è³½ã€‹æ‰“åˆ° LV.${level} ${finalRank.title}ğŸ”¥
æœ€é«˜åˆ†æ•¸ï¼š${state.score} æœ€é«˜é€£æ“Šï¼š${state.maxCombo}
ä½ æ•¢ä¾†æŒ‘æˆ°å—ï¼Ÿ`;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.share-btn');
                const originalText = btn.innerText;
                btn.innerText = "âœ… å·²è¤‡è£½ï¼";
                setTimeout(() => btn.innerText = originalText, 2000);
            });
        };

        /* --- 8. éŠæˆ²è¿´åœˆèˆ‡é‚è¼¯ --- */
        function spawnLetter() {
            let displayChar = '', targetKey = '', color = '#00ff00';
            if (state.inputMode === 'english') {
                if (Math.random() < 0.2) {
                    const num = Math.floor(Math.random() * 10);
                    displayChar = num.toString();
                    targetKey = displayChar;
                    color = '#ff55ff';
                } else {
                    const isUpper = Math.random() > 0.5;
                    const code = 65 + Math.floor(Math.random() * 26);
                    displayChar = String.fromCharCode(code);
                    targetKey = displayChar;
                    color = isUpper ? '#ff9900' : '#00ff00';
                }
            } else {
                const item = BOPOMOFO_MAP[Math.floor(Math.random() * BOPOMOFO_MAP.length)];
                displayChar = item.char;
                targetKey = item.key;
                color = '#00ffff';
            }

            const div = document.createElement('div');
            div.classList.add('letter');
            div.innerText = displayChar;
            div.style.color = color;
            div.style.textShadow = `0 0 10px ${color}`;
            
            const maxLeft = window.innerWidth - 80;
            const leftPos = Math.floor(Math.random() * maxLeft) + 20;
            div.style.left = leftPos + 'px';
            div.style.top = '-60px'; 

            els.gameArea.appendChild(div);
            state.letters.push({ element: div, targetKey: targetKey, y: -60, active: true });
        }

        function showFloatingText(x, y, text, isBigCombo, isRankUp = false) {
            const floatDiv = document.createElement('div');
            floatDiv.classList.add('float-text');
            if (isRankUp) floatDiv.classList.add('rank-up-text');
            
            floatDiv.innerText = text;
            floatDiv.style.left = x + 'px';
            floatDiv.style.top = y + 'px';
            
            if (isBigCombo && !isRankUp) {
                floatDiv.style.fontSize = '2rem';
                floatDiv.style.color = '#ffeb3b';
            } else if (!isRankUp) {
                floatDiv.style.fontSize = '1.2rem';
                floatDiv.style.color = '#fff';
            }

            els.gameArea.appendChild(floatDiv);
            setTimeout(() => floatDiv.remove(), 800);
        }

        function gameLoop() {
            if (state.isPlaying && !state.isPaused) {
                state.spawnTimer++;
                if (state.spawnTimer > state.rate) {
                    spawnLetter();
                    state.spawnTimer = 0;
                }

                for (let i = state.letters.length - 1; i >= 0; i--) {
                    let obj = state.letters[i];
                    if (!obj.active) continue;

                    obj.y += state.speed;
                    obj.element.style.top = obj.y + 'px';

                    if (obj.y > window.innerHeight) {
                        handleMiss(obj, i);
                    }
                }
            }
            requestAnimationFrame(gameLoop);
        }

        function handleMiss(obj, index) {
            obj.active = false;
            obj.element.remove();
            state.letters.splice(index, 1);
            Sound.miss();

            state.combo = 0;
            els.combo.innerText = 0;
            updateVisualEffects();

            if (state.gameMode === 'challenge') {
                state.lives--;
                updateChallengeUI();

                if (state.lives <= 0) {
                    gameOver();
                }
            } else {
                if (state.score > 0) {
                    state.score = 0;
                    els.score.innerText = 0;
                }
            }
        }

        // ç›£è½éµç›¤è¼¸å…¥
        document.addEventListener('keydown', (e) => {
            if (state.gameMode === 'noob' && e.key === 'Escape') {
                if (state.isPlaying) togglePause();
                return;
            }

            if (!state.isPlaying || state.isPaused) return;

            if (e.key === ' ') e.preventDefault();

            const inputKey = e.key.toLowerCase();
            let targetIndex = -1;
            let maxY = -Infinity;

            state.letters.forEach((obj, i) => {
                if (!obj.active) return;
                if (obj.targetKey.toLowerCase() === inputKey && obj.y > maxY) {
                    maxY = obj.y;
                    targetIndex = i;
                }
            });

            if (targetIndex === -1) return;

            const target = state.letters[targetIndex];

            const basePoints = CONSTANTS.POINTS_PER_HIT;
            const points = basePoints + state.combo;
            state.score += points;
            state.combo++;

            if (state.combo > state.maxCombo) {
                state.maxCombo = state.combo;
                els.maxCombo.innerText = state.maxCombo;
            }

            els.score.innerText = state.score;
            els.combo.innerText = state.combo;

            if (state.combo >= 20) {
                Sound.hitHigh();
            } else {
                Sound.hit();
            }

            const rect = target.element.getBoundingClientRect();
            showFloatingText(rect.left, rect.top, `+${points}`, state.combo >= 10);

            if (state.gameMode === 'challenge') {
                checkRankByHits();
            }

            updateVisualEffects();

            target.active = false;
            target.element.classList.add('poof');
            setTimeout(() => target.element.remove(), 200);
            state.letters.splice(targetIndex, 1);
        });

        init();
    </script>

<div style="margin-top: 30px; text-align: center; font-size: 12px; color: #aaa;">
  Designed & Created by Ken Â© 2025
</div>
    
</body>
</html>



